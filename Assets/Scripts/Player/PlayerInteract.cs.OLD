using UnityEngine;
using UnityEngine.UI;

public class PlayerInteract : MonoBehaviour
{
    [Header("Cài đặt Tương tác")]
    public float interactRange = 4f; // Tăng xa lên chút cho dễ bấm
    public Camera playerCam;
    
    [Header("UI Prompt (Nhấn E)")]
    public GameObject interactPromptUI; // Kéo GameObject chứa Text "Nhấn E để thắp đèn" vào đây
    public Text interactPromptText; // Hoặc kéo Text component trực tiếp vào đây (nếu không dùng GameObject)
    
    [Header("Tùy chỉnh Text")]
    public string interactText = "Nhấn [E] để thắp đèn";
    public string interactTextLit = "Đèn đã sáng";
    
    private Lantern currentLantern = null; // Đèn đang nhìn vào

    void Start()
    {
        // Ẩn UI prompt lúc bắt đầu
        if (interactPromptUI != null)
        {
            interactPromptUI.SetActive(false);
        }
        else if (interactPromptText != null)
        {
            interactPromptText.gameObject.SetActive(false);
        }
    }

    void Update()
    {
        // Luôn kiểm tra xem có đang nhìn vào đèn không (không chỉ khi bấm E)
        CheckForInteractable();
        
        // Xử lý khi bấm E
        if (Input.GetKeyDown(KeyCode.E))
        {
            if (currentLantern != null && !currentLantern.isLit)
            {
                currentLantern.LightUp();
                Debug.Log("Đã tìm thấy đèn và thắp sáng!"); // Báo tin vui
                
                // Cập nhật text sau khi thắp đèn
                UpdatePromptText(true);
            }
        }
    }
    
    /// <summary>
    /// Kiểm tra xem có đang nhìn vào đèn không (gọi mỗi frame)
    /// </summary>
    void CheckForInteractable()
    {
        if (playerCam == null) return;
        
        Ray ray = new Ray(playerCam.transform.position, playerCam.transform.forward);
        RaycastHit hit;

        // Debug: Vẽ tia màu đỏ trong Scene để bạn thấy tia bắn đi đâu (chỉ hiện trong Scene, ko hiện trong Game)
        Debug.DrawRay(playerCam.transform.position, playerCam.transform.forward * interactRange, Color.red, 0.1f);

        if (Physics.Raycast(ray, out hit, interactRange))
        {
            // Tìm script Lantern trên vật bị bắn trúng HOẶC cha của nó
            Lantern lantern = hit.collider.GetComponentInParent<Lantern>();
            
            if (lantern != null)
            {
                currentLantern = lantern;
                
                // Hiển thị UI prompt nếu đèn chưa sáng
                if (!lantern.isLit)
                {
                    ShowPrompt(true);
                    UpdatePromptText(false);
                }
                else
                {
                    // Đèn đã sáng rồi, có thể hiển thị text khác hoặc ẩn đi
                    ShowPrompt(false);
                }
            }
            else
            {
                // Không phải đèn, ẩn prompt
                currentLantern = null;
                ShowPrompt(false);
            }
        }
        else
        {
            // Không bắn trúng gì, ẩn prompt
            currentLantern = null;
            ShowPrompt(false);
        }
    }
    
    /// <summary>
    /// Hiển thị hoặc ẩn UI prompt
    /// </summary>
    void ShowPrompt(bool show)
    {
        if (interactPromptUI != null)
        {
            interactPromptUI.SetActive(show);
        }
        else if (interactPromptText != null)
        {
            interactPromptText.gameObject.SetActive(show);
        }
    }
    
    /// <summary>
    /// Cập nhật nội dung text của prompt
    /// </summary>
    void UpdatePromptText(bool isLit)
    {
        if (interactPromptText != null)
        {
            interactPromptText.text = isLit ? interactTextLit : interactText;
        }
        // Nếu dùng GameObject, tìm Text component bên trong
        else if (interactPromptUI != null)
        {
            Text textComponent = interactPromptUI.GetComponentInChildren<Text>();
            if (textComponent != null)
            {
                textComponent.text = isLit ? interactTextLit : interactText;
            }
        }
    }
}

